<!DOCTYPE html>
<html>
<head>
  <style>
  body, html {
    height: 100%;
    width: 100%;
    margin: 0;
    background: transparent;
    overflow: hidden;
  }

  #viewport-left {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 50%;
  }

  #viewport-right {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 50%;
  }

  .page {
    /* Centers vertically the iframe */
    position: absolute;
    top: 50%;
    transform: translateY(-50%);

    width: 0px;
    height: 0px;
    border: none;
    background: white;
  }

  #page-left {
    right: 0;
  }

  #page-right {
    left: 0;
  }
  </style>

  <meta name="viewport" content="">
</head>

<body>
  <div id="viewport-left">
    <iframe id="page-left" class="page"></iframe>
  </div>
  <div id="viewport-right">
    <iframe id="page-right" class="page"></iframe>
  </div>

  <script type="text/javascript">
    var spread = (function() {

      function Page(iframeId) {
        // Fixed dimensions for the page, extracted from the viewport meta tag.
        var _pageSize = null;
        // Available viewport size to fill with the resource.
        var _viewportSize = null;
        // Margins that should not overlap the content.
        var _safeAreaInsets = null;

        // iFrame containing the page.
        var _iframe = document.getElementById(iframeId);
        _iframe.addEventListener('load', loadPageSize);

        // Parses the page size from the viewport meta tag of the loaded resource.
        function loadPageSize() {
          var viewport = _iframe.contentWindow.document.querySelector('meta[name=viewport]');
          if (!viewport) {
            return;
          }
          var regex = /(\w+) *= *([^\s,]+)/g
          var properties = {};
          var match;
          while (match = regex.exec(viewport.content)) {
            properties[match[1]] = match[2];
          }
          var width = Number.parseFloat(properties.width);
          var height = Number.parseFloat(properties.height);
          if (width && height) {
            _pageSize = { 'width': width, 'height': height };
            layoutPage();
          }
        }

        // Layouts the page iframe to center its content and scale it to fill the available viewport.
        function layoutPage() {
          if (!_pageSize || !_viewportSize || !_safeAreaInsets) {
            return;
          }

          _iframe.style.width = _pageSize.width + 'px';
          _iframe.style.height = _pageSize.height + 'px';
          _iframe.style.marginTop = (_safeAreaInsets.top - _safeAreaInsets.bottom) + 'px';
          _iframe.style.marginLeft = (_safeAreaInsets.left - _safeAreaInsets.right) + 'px';

          // Calculates the zoom scale required to fit the content to the viewport.
          var widthRatio = _viewportSize.width / _pageSize.width;
          var heightRatio = _viewportSize.height / _pageSize.height;
          var scale = Math.min(widthRatio, heightRatio);

          // Sets the viewport of the wrapper page (this page) to scale the iframe.
          var viewport = document.querySelector('meta[name=viewport]');
          viewport.content = 'initial-scale=' + scale + ', minimum-scale=' + scale;
        }

        return {
          // Loads the given URL in the page.
          'load': function(url) {
            _iframe.src = url;
          },

          // Evaluates a script in the context of the page.
          'eval': function(script) {
            return _iframe.contentWindow.eval(script);
          },

          // Updates the available viewport to display the resource.
          'setViewport': function(viewportSize, safeAreaInsets) {
            _viewportSize = viewportSize;
            _safeAreaInsets = safeAreaInsets;
            layoutPage();
          }
        };
      }

      var _leftPage = Page('page-left');
      var _rightPage = Page('page-right');

      // Map between a resource href and the matching page in the spread.
      var _pages = {};

      // Fixed dimensions for the resource extracted from the viewport meta tag.
      var _pageSize = null;
      // Available viewport size to fill with the resource.
      var _viewportSize = null;
      // Margins that should not overlap the content.
      var _safeAreaInsets = null;

      // Public API called from Swift.
      return {
        // Loads resources in the spread.
        'load': function(leftHref, leftURL, rightHref, rightURL) {
          _pages = {};
          if (leftHref && leftURL) {
            _leftPage.load(leftURL);
            _pages[leftHref] = _leftPage;
          }
          if (rightHref && rightURL) {
            _rightPage.load(rightURL);
            _pages[rightHref] = _rightPage;
          }
        },

        // Evaluates a JavaScript in the context of a resource.
        'eval': function(href, script) {
          if (href == '#') {
            for (currentHref in _pages) {
              _pages[currentHref].eval(script);
            }
          } else {
            var page = _pages[href];
            if (!page) {
              return;
            }
            return page.eval(script);
          }
        },

        // Updates the available viewport to display the resources.
        'setViewport': function(viewportSize, safeAreaInsets) {
          viewportSize.width /= 2;

          _leftPage.setViewport(viewportSize, {
            top: safeAreaInsets.top,
            right: 0,
            bottom: safeAreaInsets.bottom,
            left: safeAreaInsets.left
          });

          _rightPage.setViewport(viewportSize, {
            top: safeAreaInsets.top,
            right: safeAreaInsets.right,
            bottom: safeAreaInsets.bottom,
            left: 0
          });
        }
      }
    })();
  </script>
</body>
</html>
